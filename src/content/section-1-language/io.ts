import type { Chapter } from '../types'

export default {
  id: 'io',
  title: 'Ввод и вывод',
  description: 'printf, scanf, форматные спецификаторы',
  blocks: [
    {
      type: 'prose',
      markdown: `# Ввод и вывод

Почти любая программа взаимодействует с пользователем: выводит результаты и принимает данные. В C для этого используются функции из заголовочного файла \`<stdio.h>\` (standard input/output).

Две самые важные функции:
- **\`printf\`** — форматированный вывод (print formatted)
- **\`scanf\`** — форматированный ввод (scan formatted)`,
    },
    {
      type: 'prose',
      markdown: `## printf — форматированный вывод

Функция \`printf\` выводит данные в стандартный поток вывода (stdout), обычно — в терминал. Её первый аргумент — **форматная строка**, содержащая обычный текст и **спецификаторы формата**, начинающиеся с \`%\`:

\`\`\`c
printf("формат", аргумент1, аргумент2, ...);
\`\`\`

Каждый спецификатор \`%\` заменяется соответствующим аргументом.`,
    },
    {
      type: 'code',
      language: 'c',
      code: `#include <stdio.h>

int main(void)
{
    int age = 25;
    float height = 1.78f;
    char grade = 'A';
    const char *name = "Алексей";

    printf("Имя: %s\\n", name);
    printf("Возраст: %d лет\\n", age);
    printf("Рост: %.2f м\\n", height);
    printf("Оценка: %c\\n", grade);

    // Несколько спецификаторов в одной строке
    printf("%s, %d лет, рост %.2f м\\n", name, age, height);

    return 0;
}`,
      filename: 'printf_basic.c',
    },
    {
      type: 'output',
      content: `Имя: Алексей
Возраст: 25 лет
Рост: 1.78 м
Оценка: A
Алексей, 25 лет, рост 1.78 м`,
      prompt: '$ gcc printf_basic.c -o printf_basic && ./printf_basic',
    },
    {
      type: 'prose',
      markdown: `## Таблица форматных спецификаторов

| Спецификатор | Тип | Пример | Результат |
|-------------|-----|--------|-----------|
| \`%d\` или \`%i\` | \`int\` (десятичный) | \`printf("%d", 42)\` | \`42\` |
| \`%u\` | \`unsigned int\` | \`printf("%u", 42)\` | \`42\` |
| \`%ld\` | \`long\` | \`printf("%ld", 100000L)\` | \`100000\` |
| \`%lld\` | \`long long\` | \`printf("%lld", 9000000000LL)\` | \`9000000000\` |
| \`%f\` | \`float\`/\`double\` | \`printf("%f", 3.14)\` | \`3.140000\` |
| \`%e\` | научная нотация | \`printf("%e", 3.14)\` | \`3.140000e+00\` |
| \`%g\` | \`%f\` или \`%e\` (короче) | \`printf("%g", 3.14)\` | \`3.14\` |
| \`%c\` | \`char\` (символ) | \`printf("%c", 'A')\` | \`A\` |
| \`%s\` | строка (\`char*\`) | \`printf("%s", "hi")\` | \`hi\` |
| \`%x\` | hex (строчные) | \`printf("%x", 255)\` | \`ff\` |
| \`%X\` | hex (заглавные) | \`printf("%X", 255)\` | \`FF\` |
| \`%o\` | восьмеричный | \`printf("%o", 255)\` | \`377\` |
| \`%p\` | адрес (указатель) | \`printf("%p", &x)\` | \`0x7ffc...\` |
| \`%zu\` | \`size_t\` | \`printf("%zu", sizeof(int))\` | \`4\` |
| \`%%\` | символ \`%\` | \`printf("100%%")\` | \`100%\` |`,
    },
    {
      type: 'prose',
      markdown: `## Форматирование вывода

Между \`%\` и буквой спецификатора можно указать модификаторы для управления форматом:

\`\`\`
%[флаги][ширина][.точность]спецификатор
\`\`\``,
    },
    {
      type: 'code',
      language: 'c',
      code: `#include <stdio.h>

int main(void)
{
    // Ширина поля (минимальное количество символов)
    printf("[%10d]\\n", 42);     // правое выравнивание (по умолчанию)
    printf("[%-10d]\\n", 42);    // левое выравнивание (флаг -)
    printf("[%010d]\\n", 42);    // заполнение нулями (флаг 0)

    printf("\\n");

    // Точность для дробных чисел
    double pi = 3.14159265358979;
    printf("По умолчанию: %f\\n", pi);     // 6 знаков после точки
    printf("2 знака:      %.2f\\n", pi);
    printf("0 знаков:     %.0f\\n", pi);
    printf("10 знаков:    %.10f\\n", pi);

    printf("\\n");

    // Точность для строк (максимальное количество символов)
    printf("[%.5s]\\n", "Hello, World!");   // только первые 5 символов
    printf("[%20s]\\n", "right");           // правое выравнивание
    printf("[%-20s]\\n", "left");           // левое выравнивание

    printf("\\n");

    // Комбинации
    printf("[%+d]\\n", 42);    // всегда показывать знак
    printf("[%+d]\\n", -42);
    printf("[% d]\\n", 42);    // пробел вместо +
    printf("[% d]\\n", -42);

    return 0;
}`,
      filename: 'printf_format.c',
    },
    {
      type: 'output',
      content: `[        42]
[42        ]
[0000000042]

По умолчанию: 3.141593
2 знака:      3.14
0 знаков:     3
10 знаков:    3.1415926536

[Hello]
[               right]
[left                ]

[+42]
[-42]
[ 42]
[-42]`,
      prompt: '$ gcc printf_format.c -o printf_format && ./printf_format',
    },
    {
      type: 'note',
      variant: 'tip',
      title: 'Вывод таблиц',
      markdown:
        'Модификаторы ширины и выравнивания особенно полезны для вывода таблиц. Например, `printf("%-15s %8.2f\\n", name, price)` выровняет имена по левому краю в колонке шириной 15, а цены — по правому краю с двумя десятичными знаками.',
    },
    {
      type: 'code',
      language: 'c',
      code: `#include <stdio.h>

int main(void)
{
    // Пример: форматированная таблица
    printf("%-20s %8s %10s\\n", "Товар", "Кол-во", "Цена");
    printf("%-20s %8s %10s\\n", "--------------------", "--------", "----------");
    printf("%-20s %8d %10.2f\\n", "Молоко", 2, 89.90);
    printf("%-20s %8d %10.2f\\n", "Хлеб", 1, 45.50);
    printf("%-20s %8d %10.2f\\n", "Яблоки (кг)", 3, 120.00);
    printf("%-20s %8s %10.2f\\n", "", "Итого:", 2 * 89.90 + 45.50 + 3 * 120.00);

    return 0;
}`,
      filename: 'table.c',
    },
    {
      type: 'output',
      content: `Товар                 Кол-во      Цена
--------------------  --------  ----------
Молоко                       2      89.90
Хлеб                         1      45.50
Яблоки (кг)                  3     120.00
                       Итого:     585.30`,
      prompt: '$ gcc table.c -o table && ./table',
    },
    {
      type: 'prose',
      markdown: `## Числовые системы

\`printf\` позволяет выводить числа в разных системах счисления:`,
    },
    {
      type: 'code',
      language: 'c',
      code: `#include <stdio.h>

int main(void)
{
    int num = 255;

    printf("Десятичная:        %d\\n", num);
    printf("Восьмеричная:      %o\\n", num);
    printf("Шестнадцатеричная:  %x\\n", num);
    printf("Шестнадцатеричная:  %X\\n", num);

    // Флаг # добавляет префикс системы счисления
    printf("\\nС префиксом:\\n");
    printf("Восьмеричная:      %#o\\n", num);
    printf("Шестнадцатеричная:  %#x\\n", num);
    printf("Шестнадцатеричная:  %#X\\n", num);

    return 0;
}`,
      filename: 'numbase.c',
    },
    {
      type: 'output',
      content: `Десятичная:        255
Восьмеричная:      377
Шестнадцатеричная:  ff
Шестнадцатеричная:  FF

С префиксом:
Восьмеричная:      0377
Шестнадцатеричная:  0xff
Шестнадцатеричная:  0XFF`,
      prompt: '$ gcc numbase.c -o numbase && ./numbase',
    },
    {
      type: 'prose',
      markdown: `## scanf — форматированный ввод

Функция \`scanf\` читает данные из стандартного потока ввода (stdin) и записывает их в переменные. Ключевое отличие от \`printf\`: в \`scanf\` передаются **адреса** переменных (с помощью оператора \`&\`):`,
    },
    {
      type: 'code',
      language: 'c',
      code: `#include <stdio.h>

int main(void)
{
    int age;
    float height;
    char initial;

    printf("Введите возраст: ");
    scanf("%d", &age);          // &age — адрес переменной age

    printf("Введите рост (в метрах): ");
    scanf("%f", &height);

    printf("Введите первую букву имени: ");
    scanf(" %c", &initial);     // пробел перед %c пропускает пробельные символы

    printf("\\nВозраст: %d, рост: %.2f м, инициал: %c\\n",
           age, height, initial);

    return 0;
}`,
      filename: 'scanf_basic.c',
    },
    {
      type: 'output',
      content: `Введите возраст: 25
Введите рост (в метрах): 1.78
Введите первую букву имени: A

Возраст: 25, рост: 1.78 м, инициал: A`,
      prompt: '$ gcc scanf_basic.c -o scanf_basic && ./scanf_basic',
    },
    {
      type: 'note',
      variant: 'danger',
      title: 'Не забывайте &!',
      markdown:
        'Самая частая ошибка при использовании `scanf` — забыть оператор `&` перед именем переменной. `scanf("%d", age)` вместо `scanf("%d", &age)` — это **неопределённое поведение**, которое часто приводит к аварийному завершению программы (segmentation fault). Оператор `&` возвращает адрес переменной в памяти — именно по этому адресу `scanf` записывает прочитанное значение.',
    },
    {
      type: 'note',
      variant: 'warning',
      title: 'Пробел перед %c',
      markdown:
        'При чтении символа через `%c` после предыдущего ввода в буфере может остаться символ новой строки `\\n`. Чтобы его пропустить, добавьте пробел перед `%c`: `scanf(" %c", &ch)`. Пробел в форматной строке `scanf` означает «пропустить все пробельные символы».',
    },
    {
      type: 'prose',
      markdown: `## Чтение нескольких значений

\`scanf\` может читать несколько значений за один вызов:`,
    },
    {
      type: 'code',
      language: 'c',
      code: `#include <stdio.h>

int main(void)
{
    int day, month, year;

    printf("Введите дату (ДД.ММ.ГГГГ): ");
    scanf("%d.%d.%d", &day, &month, &year);
    printf("День: %d, Месяц: %d, Год: %d\\n", day, month, year);

    // Чтение координат
    float x, y;
    printf("Введите координаты (x y): ");
    scanf("%f %f", &x, &y);
    printf("Точка: (%.1f, %.1f)\\n", x, y);

    return 0;
}`,
      filename: 'scanf_multi.c',
    },
    {
      type: 'output',
      content: `Введите дату (ДД.ММ.ГГГГ): 15.03.2024
День: 15, Месяц: 3, Год: 2024
Введите координаты (x y): 3.5 7.2
Точка: (3.5, 7.2)`,
      prompt: '$ gcc scanf_multi.c -o scanf_multi && ./scanf_multi',
    },
    {
      type: 'prose',
      markdown: `## Проверка возвращаемого значения scanf

Функция \`scanf\` возвращает количество успешно прочитанных значений. Это важно для обработки ошибок ввода:`,
    },
    {
      type: 'code',
      language: 'c',
      code: `#include <stdio.h>

int main(void)
{
    int num;

    printf("Введите целое число: ");
    int result = scanf("%d", &num);

    if (result == 1) {
        printf("Вы ввели: %d\\n", num);
    } else {
        printf("Ошибка: введено не число!\\n");
    }

    // Ожидаем два числа
    int a, b;
    printf("Введите два числа: ");
    result = scanf("%d %d", &a, &b);

    if (result == 2) {
        printf("Сумма: %d\\n", a + b);
    } else if (result == 1) {
        printf("Ошибка: введено только одно число\\n");
    } else {
        printf("Ошибка: ничего не введено\\n");
    }

    return 0;
}`,
      filename: 'scanf_check.c',
    },
    {
      type: 'note',
      variant: 'info',
      title: 'Альтернативы scanf',
      markdown: `\`scanf\` — удобная, но не самая безопасная функция. Основные проблемы:
- Чтение строк через \`%s\` не ограничивает длину (переполнение буфера!)
- Необработанный ввод остаётся в буфере
- Сложно обрабатывать некорректный ввод

Для более надёжного чтения рекомендуется:
- \`fgets\` для чтения строк
- \`fgets\` + \`sscanf\` для чтения чисел
- \`strtol\`/\`strtod\` для парсинга чисел из строк

Мы познакомимся с этими функциями в будущих главах.`,
    },
    {
      type: 'prose',
      markdown: `## Другие функции ввода-вывода

Помимо \`printf\` и \`scanf\`, стандартная библиотека предоставляет ещё несколько полезных функций:`,
    },
    {
      type: 'code',
      language: 'c',
      code: `#include <stdio.h>

int main(void)
{
    // putchar — выводит один символ
    putchar('H');
    putchar('i');
    putchar('!');
    putchar('\\n');

    // puts — выводит строку с автоматическим переводом строки
    puts("Hello, World!");  // эквивалентно printf("Hello, World!\\n")

    // getchar — читает один символ
    printf("Нажмите любую клавишу: ");
    int ch = getchar();  // возвращает int (для обработки EOF)
    printf("Вы нажали: '%c' (код %d)\\n", ch, ch);

    return 0;
}`,
      filename: 'io_funcs.c',
    },
    {
      type: 'codeDiff',
      before: `// Небезопасно: переполнение буфера!
char name[20];
scanf("%s", name);`,
      after: `// Безопасно: ограничение длины ввода
char name[20];
scanf("%19s", name);  // максимум 19 символов + '\\0'

// Ещё лучше: fgets
fgets(name, sizeof(name), stdin);`,
      language: 'c',
      description:
        'Всегда ограничивайте длину ввода при чтении строк. Спецификатор %19s читает максимум 19 символов.',
    },
    {
      type: 'quiz',
      question:
        'Какой спецификатор формата используется для вывода значения типа double с двумя десятичными знаками?',
      options: ['%d', '%2f', '%.2f', '%2.f'],
      correctIndex: 2,
      explanation:
        'Спецификатор `%.2f` выводит число с плавающей точкой с точностью 2 знака после десятичной точки. `%d` — для целых чисел, `%2f` задаёт минимальную ширину 2 (а не точность), `%2.f` — ширина 2 и точность 0.',
    },
    {
      type: 'quiz',
      question: 'Что вернёт scanf("%d %d", &a, &b) если пользователь введёт "42 hello"?',
      options: ['0', '1', '2', '-1'],
      correctIndex: 1,
      explanation:
        'scanf вернёт 1, потому что успешно прочитает первое число (42), но при попытке прочитать второе число встретит "hello" и остановится. Возвращаемое значение — количество успешно прочитанных элементов.',
    },
    {
      type: 'exercise',
      title: 'Калькулятор',
      description: `Напишите программу-калькулятор, которая:
1. Просит пользователя ввести два числа (типа \`double\`)
2. Выводит результаты всех четырёх арифметических операций: сложения, вычитания, умножения и деления
3. Форматирует результаты с двумя десятичными знаками
4. Проверяет деление на ноль

Пример:
\`\`\`
Введите первое число: 10.5
Введите второе число: 3
10.50 + 3.00 = 13.50
10.50 - 3.00 = 7.50
10.50 * 3.00 = 31.50
10.50 / 3.00 = 3.50
\`\`\``,
      hints: [
        'Используйте тип double для обоих чисел',
        'Спецификатор %lf для scanf с double',
        'Спецификатор %.2f для вывода с 2 знаками',
        'Проверьте второе число на равенство нулю перед делением',
      ],
      solution: `#include <stdio.h>

int main(void)
{
    double a, b;

    printf("Введите первое число: ");
    scanf("%lf", &a);

    printf("Введите второе число: ");
    scanf("%lf", &b);

    printf("%.2f + %.2f = %.2f\\n", a, b, a + b);
    printf("%.2f - %.2f = %.2f\\n", a, b, a - b);
    printf("%.2f * %.2f = %.2f\\n", a, b, a * b);

    if (b != 0) {
        printf("%.2f / %.2f = %.2f\\n", a, b, a / b);
    } else {
        printf("Деление на ноль невозможно!\\n");
    }

    return 0;
}`,
      solutionLanguage: 'c',
    },
    {
      type: 'exercise',
      title: 'Конвертер температур',
      description: `Напишите программу, которая:
1. Просит ввести температуру в градусах Цельсия
2. Переводит её в Фаренгейт по формуле: \`F = C * 9/5 + 32\`
3. Переводит её в Кельвин: \`K = C + 273.15\`
4. Выводит все три значения с одним десятичным знаком

Пример:
\`\`\`
Введите температуру (°C): 100
100.0 °C = 212.0 °F = 373.1 K
\`\`\``,
      hints: [
        'Используйте тип double для всех температур',
        'Формула Фаренгейта: F = C * 9.0 / 5.0 + 32.0',
        'Обратите внимание: 9/5 в целых числах даёт 1! Используйте 9.0/5.0',
      ],
      solution: `#include <stdio.h>

int main(void)
{
    double celsius;

    printf("Введите температуру (°C): ");
    scanf("%lf", &celsius);

    double fahrenheit = celsius * 9.0 / 5.0 + 32.0;
    double kelvin = celsius + 273.15;

    printf("%.1f °C = %.1f °F = %.1f K\\n", celsius, fahrenheit, kelvin);

    return 0;
}`,
      solutionLanguage: 'c',
    },
  ],
} satisfies Chapter
